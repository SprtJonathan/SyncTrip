<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:SyncTrip.App.Features.Chat.ViewModels"
             xmlns:dto="clr-namespace:SyncTrip.Shared.DTOs.Chat;assembly=SyncTrip.Shared"
             x:Class="SyncTrip.App.Features.Chat.Views.ChatView"
             x:DataType="vm:ChatViewModel">

    <Grid RowDefinitions="Auto,*,Auto,Auto">

        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource PrimaryBrush}" Padding="15">
            <Grid ColumnDefinitions="Auto,*">
                <Button Grid.Column="0" Content="Retour"
                        Command="{Binding GoBackCommand}"
                        Background="Transparent" Foreground="White" VerticalAlignment="Center" />
                <TextBlock Grid.Column="1" Text="Chat du convoi"
                           FontSize="18" FontWeight="Bold" Foreground="White"
                           HorizontalAlignment="Center" VerticalAlignment="Center" />
            </Grid>
        </Border>

        <!-- Loading -->
        <ProgressBar Grid.Row="1" IsVisible="{Binding IsLoading}" IsIndeterminate="True" Height="4"
                     VerticalAlignment="Top" />

        <!-- Messages list -->
        <ScrollViewer Grid.Row="1" Margin="0,5,0,0">
            <StackPanel Spacing="5">
                <!-- Load more button -->
                <Button Content="Charger plus..."
                        Command="{Binding LoadMoreCommand}"
                        IsVisible="{Binding CanLoadMore}"
                        HorizontalAlignment="Center" Margin="0,10"
                        Background="Transparent" Foreground="{DynamicResource PrimaryBrush}" />

                <!-- Messages -->
                <ItemsControl ItemsSource="{Binding Messages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="dto:MessageDto">
                            <Border Margin="10,3" Padding="12,8" CornerRadius="12"
                                    Background="{DynamicResource Gray100Brush}">
                                <StackPanel Spacing="4">
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <TextBlock Text="{Binding SenderUsername}"
                                                   FontSize="13" FontWeight="Bold"
                                                   Foreground="{DynamicResource PrimaryBrush}" />
                                        <TextBlock Text="{Binding SentAt, StringFormat='{}{0:HH:mm}'}"
                                                   FontSize="11" Foreground="{DynamicResource Gray500Brush}"
                                                   VerticalAlignment="Center" />
                                    </StackPanel>
                                    <TextBlock Text="{Binding Content}" FontSize="14" TextWrapping="Wrap" />
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <!-- Empty state -->
                <TextBlock IsVisible="{Binding HasMessages, Converter={StaticResource InvertedBoolConverter}}"
                           Text="Aucun message. Commencez la conversation !"
                           FontSize="14" Foreground="{DynamicResource Gray500Brush}"
                           HorizontalAlignment="Center" Margin="0,40" />
            </StackPanel>
        </ScrollViewer>

        <!-- Error -->
        <Border Grid.Row="2"
                IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                BorderBrush="{DynamicResource ErrorBrush}" BorderThickness="1" CornerRadius="10"
                Padding="10" Margin="10,5">
            <TextBlock Text="{Binding ErrorMessage}" Foreground="{DynamicResource ErrorBrush}"
                       HorizontalAlignment="Center" TextWrapping="Wrap" FontSize="12" />
        </Border>

        <!-- Input bar -->
        <Border Grid.Row="3" Background="{DynamicResource Gray100Brush}" Padding="10">
            <Grid ColumnDefinitions="*,Auto">
                <Border Grid.Column="0" Background="White" CornerRadius="20" Padding="15,8" Margin="0,0,10,0">
                    <TextBox Watermark="Votre message..." Text="{Binding MessageText}"
                             MaxLength="500" BorderThickness="0" />
                </Border>
                <Button Grid.Column="1" Content="Envoyer"
                        Command="{Binding SendMessageCommand}"
                        IsEnabled="{Binding IsSending, Converter={StaticResource InvertedBoolConverter}}"
                        Background="{DynamicResource PrimaryBrush}" Foreground="White"
                        CornerRadius="20" FontWeight="Bold" VerticalAlignment="Center" />
            </Grid>
        </Border>

    </Grid>

</UserControl>
