<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SyncTrip.Mobile.Features.Convoy.ViewModels"
             xmlns:dto="clr-namespace:SyncTrip.Shared.DTOs.Convoys;assembly=SyncTrip.Shared"
             x:Class="SyncTrip.Mobile.Features.Convoy.Views.ConvoyDetailPage"
             x:DataType="vm:ConvoyDetailViewModel"
             Title="Detail du convoi">

    <RefreshView IsRefreshing="{Binding IsLoading}"
                 Command="{Binding LoadDetailsCommand}">
        <ScrollView>
            <VerticalStackLayout Padding="20" Spacing="15">

                <!-- Header -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                       CornerRadius="15"
                       Padding="20"
                       HasShadow="True">
                    <VerticalStackLayout Spacing="8">
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="Code :"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                            <Label Text="{Binding Convoy.JoinCode}"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="10">
                            <Label Text="Leader :"
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                            <Label Text="{Binding Convoy.LeaderUsername}"
                                   FontSize="14"
                                   FontAttributes="Bold" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>

                <!-- Voyage actif -->
                <Frame BorderColor="{StaticResource Primary}"
                       CornerRadius="15"
                       Padding="15"
                       HasShadow="True"
                       IsVisible="{Binding HasActiveTrip}">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Voyage en cours"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{StaticResource Primary}" />
                        <Label Text="{Binding ActiveTrip.Status, Converter={StaticResource TripStatusConverter}}"
                               FontSize="14" />
                        <Grid ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Button Grid.Column="0"
                                    Text="Ouvrir le cockpit"
                                    Command="{Binding OpenCockpitCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    CornerRadius="10" />
                            <Button Grid.Column="1"
                                    Text="Terminer"
                                    Command="{Binding EndTripCommand}"
                                    BackgroundColor="{StaticResource Error}"
                                    TextColor="White"
                                    CornerRadius="10"
                                    IsVisible="{Binding IsLeader}" />
                        </Grid>
                    </VerticalStackLayout>
                </Frame>

                <!-- Bouton demarrer (leader, pas de voyage actif) -->
                <Button Text="Demarrer un voyage"
                        Command="{Binding StartTripCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        CornerRadius="10"
                        HeightRequest="50"
                        IsVisible="{Binding IsLeader}">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button"
                                     Binding="{Binding HasActiveTrip}"
                                     Value="True">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>

                <!-- Membres -->
                <Label Text="Membres"
                       FontSize="18"
                       FontAttributes="Bold"
                       Margin="0,10,0,0" />

                <CollectionView ItemsSource="{Binding Convoy.Members}"
                                SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="dto:ConvoyMemberDto">
                            <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                   CornerRadius="10"
                                   Padding="12"
                                   Margin="0,4"
                                   HasShadow="False">
                                <Grid ColumnSpacing="10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                                        <Label Text="{Binding Username}"
                                               FontSize="16"
                                               FontAttributes="Bold" />
                                        <Label FontSize="12"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}">
                                            <Label.Text>
                                                <MultiBinding StringFormat="{}{0} {1}">
                                                    <Binding Path="VehicleBrand" />
                                                    <Binding Path="VehicleModel" />
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                    </VerticalStackLayout>

                                    <Frame Grid.Column="1"
                                           BackgroundColor="{StaticResource Primary}"
                                           Padding="8,4"
                                           CornerRadius="8"
                                           HasShadow="False"
                                           VerticalOptions="Center">
                                        <Label Text="{Binding Role, Converter={StaticResource ConvoyRoleConverter}}"
                                               FontSize="11"
                                               TextColor="White" />
                                    </Frame>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Error Message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                       BorderColor="{StaticResource Error}"
                       BackgroundColor="Transparent"
                       Padding="15"
                       CornerRadius="10"
                       HasShadow="False">
                    <Label Text="{Binding ErrorMessage}"
                           TextColor="{StaticResource Error}"
                           HorizontalOptions="Center" />
                </Frame>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>

</ContentPage>
