<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SyncTrip.Mobile.Features.Convoy.ViewModels"
             xmlns:dto="clr-namespace:SyncTrip.Shared.DTOs.Convoys;assembly=SyncTrip.Shared"
             x:Class="SyncTrip.Mobile.Features.Convoy.Views.ConvoyLobbyPage"
             x:DataType="vm:ConvoyLobbyViewModel"
             Title="Mes Convois">

    <Grid>
        <RefreshView IsRefreshing="{Binding IsLoading}"
                     Command="{Binding RefreshCommand}">
            <ScrollView>
                <VerticalStackLayout Padding="20" Spacing="15">

                    <!-- Header -->
                    <Label Text="Mes Convois"
                           FontSize="24"
                           FontAttributes="Bold"
                           Margin="0,20,0,10" />

                    <!-- Action Buttons -->
                    <Grid ColumnSpacing="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <Button Grid.Column="0"
                                Text="Creer un convoi"
                                Command="{Binding CreateConvoyCommand}"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                CornerRadius="10"
                                HeightRequest="50" />

                        <Button Grid.Column="1"
                                Text="Rejoindre"
                                Command="{Binding JoinConvoyCommand}"
                                BackgroundColor="{StaticResource Secondary}"
                                TextColor="White"
                                CornerRadius="10"
                                HeightRequest="50" />
                    </Grid>

                    <!-- Empty State -->
                    <VerticalStackLayout IsVisible="{Binding IsEmpty}"
                                        Spacing="20"
                                        Padding="20"
                                        VerticalOptions="Center"
                                        Margin="0,60,0,0">
                        <Label Text="Aucun convoi"
                               FontSize="20"
                               FontAttributes="Bold"
                               HorizontalOptions="Center" />
                        <Label Text="Creez ou rejoignez un convoi pour commencer"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center" />
                    </VerticalStackLayout>

                    <!-- Convoy List -->
                    <CollectionView ItemsSource="{Binding Convoys}"
                                   IsVisible="{Binding IsEmpty, Converter={StaticResource InvertedBoolConverter}}"
                                   SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="dto:ConvoyDto">
                                <SwipeView>
                                    <SwipeView.RightItems>
                                        <SwipeItems>
                                            <SwipeItem Text="Quitter"
                                                       BackgroundColor="{StaticResource Error}"
                                                       Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ConvoyLobbyViewModel}}, Path=LeaveConvoyCommand}"
                                                       CommandParameter="{Binding JoinCode}" />
                                        </SwipeItems>
                                    </SwipeView.RightItems>

                                    <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                                           CornerRadius="15"
                                           Padding="15"
                                           Margin="0,5"
                                           HasShadow="True">
                                        <Frame.GestureRecognizers>
                                            <TapGestureRecognizer
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ConvoyLobbyViewModel}}, Path=SelectConvoyCommand}"
                                                CommandParameter="{Binding .}" />
                                        </Frame.GestureRecognizers>
                                        <Grid RowSpacing="8">
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!-- Code -->
                                            <HorizontalStackLayout Grid.Row="0" Spacing="10">
                                                <Label Text="Code :"
                                                       FontSize="14"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                                <Label Text="{Binding JoinCode}"
                                                       FontSize="18"
                                                       FontAttributes="Bold"
                                                       TextColor="{StaticResource Primary}" />
                                            </HorizontalStackLayout>

                                            <!-- Leader -->
                                            <HorizontalStackLayout Grid.Row="1" Spacing="10">
                                                <Label Text="Leader :"
                                                       FontSize="14"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                                <Label Text="{Binding LeaderUsername}"
                                                       FontSize="14"
                                                       FontAttributes="Bold" />
                                            </HorizontalStackLayout>

                                            <!-- Info -->
                                            <HorizontalStackLayout Grid.Row="2" Spacing="15">
                                                <Label Text="{Binding MemberCount, StringFormat='{0} membre(s)'}"
                                                       FontSize="12"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                                <Frame BackgroundColor="{StaticResource Primary}"
                                                       Padding="8,2"
                                                       CornerRadius="8"
                                                       HasShadow="False"
                                                       IsVisible="{Binding IsPrivate}">
                                                    <Label Text="Prive"
                                                           FontSize="10"
                                                           TextColor="White" />
                                                </Frame>
                                            </HorizontalStackLayout>

                                        </Grid>
                                    </Frame>
                                </SwipeView>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Error Message -->
                    <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                           BorderColor="{StaticResource Error}"
                           BackgroundColor="Transparent"
                           Padding="15"
                           CornerRadius="10"
                           HasShadow="False">
                        <Label Text="{Binding ErrorMessage}"
                               TextColor="{StaticResource Error}"
                               HorizontalOptions="Center" />
                    </Frame>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>
    </Grid>

</ContentPage>
