<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SyncTrip.Mobile.Features.Garage.ViewModels"
             x:Class="SyncTrip.Mobile.Features.Garage.Views.AddVehiclePage"
             x:DataType="vm:AddVehicleViewModel"
             Title="Ajouter un véhicule">

    <ScrollView>
        <VerticalStackLayout Padding="30" Spacing="20">

            <!-- Header -->
            <Label Text="Nouveau véhicule"
                   FontSize="24"
                   FontAttributes="Bold"
                   Margin="0,20,0,10" />

            <Label Text="Remplissez les informations de votre véhicule"
                   FontSize="14"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                   Margin="0,0,0,20" />

            <!-- Loading Indicator -->
            <ActivityIndicator IsVisible="{Binding IsLoading}"
                              IsRunning="{Binding IsLoading}"
                              Color="{StaticResource Primary}"
                              HeightRequest="40"
                              Margin="0,20,0,0" />

            <!-- Form - Visible when not loading -->
            <VerticalStackLayout IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                                Spacing="20">

                <!-- Brand Picker (Required) -->
                <Label Text="Marque *"
                       FontSize="14"
                       FontAttributes="Bold" />
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                       CornerRadius="10"
                       Padding="15"
                       HasShadow="False">
                    <Picker ItemsSource="{Binding Brands}"
                            SelectedItem="{Binding SelectedBrand}"
                            ItemDisplayBinding="{Binding Name}"
                            Title="Sélectionnez une marque" />
                </Frame>

                <!-- Model Entry (Required) -->
                <Label Text="Modèle *"
                       FontSize="14"
                       FontAttributes="Bold" />
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                       CornerRadius="10"
                       Padding="0"
                       HasShadow="False">
                    <Entry Placeholder="Ex: 308, Clio, Golf..."
                           Text="{Binding Model}"
                           MaxLength="100"
                           Margin="15,0" />
                </Frame>

                <!-- Vehicle Type Picker (Required) -->
                <Label Text="Type de véhicule *"
                       FontSize="14"
                       FontAttributes="Bold" />
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                       CornerRadius="10"
                       Padding="15"
                       HasShadow="False">
                    <Picker ItemsSource="{Binding VehicleTypes}"
                            SelectedItem="{Binding SelectedVehicleType}"
                            ItemDisplayBinding="{Binding Name}"
                            Title="Sélectionnez un type" />
                </Frame>

                <!-- Color Entry (Optional) -->
                <Label Text="Couleur"
                       FontSize="14"
                       FontAttributes="Bold" />
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                       CornerRadius="10"
                       Padding="0"
                       HasShadow="False">
                    <Entry Placeholder="Ex: Blanc, Noir, Rouge... (optionnel)"
                           Text="{Binding Color}"
                           Margin="15,0" />
                </Frame>

                <!-- Year Entry (Optional) -->
                <Label Text="Année de fabrication"
                       FontSize="14"
                       FontAttributes="Bold" />
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                       CornerRadius="10"
                       Padding="0"
                       HasShadow="False">
                    <Grid ColumnSpacing="10" Padding="15,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Entry Grid.Column="0"
                               Placeholder="{Binding MaximumYear, StringFormat='Ex: {0}'}"
                               Text="{Binding Year}"
                               Keyboard="Numeric"
                               MaxLength="4" />

                        <Label Grid.Column="1"
                               Text="{Binding Year, StringFormat='Année: {0}'}"
                               IsVisible="{Binding Year, Converter={StaticResource IsNotNullConverter}}"
                               VerticalOptions="Center"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    </Grid>
                </Frame>

                <Label Text="{Binding MinimumYear, StringFormat='⚠️ Année entre {0} et '}{Binding MaximumYear}"
                       FontSize="12"
                       TextColor="{StaticResource Warning}"
                       Margin="0,-10,0,0">
                    <Label.FormattedText>
                        <FormattedString>
                            <Span Text="⚠️ Année entre " />
                            <Span Text="{Binding MinimumYear}" />
                            <Span Text=" et " />
                            <Span Text="{Binding MaximumYear}" />
                        </FormattedString>
                    </Label.FormattedText>
                </Label>

                <!-- Action Buttons -->
                <VerticalStackLayout Spacing="15" Margin="0,20,0,0">

                    <!-- Save Button -->
                    <Button Text="Sauvegarder"
                            Command="{Binding SaveVehicleCommand}"
                            IsEnabled="{Binding IsSaving, Converter={StaticResource InvertedBoolConverter}}"
                            HeightRequest="50"
                            CornerRadius="25"
                            FontAttributes="Bold"
                            BackgroundColor="{StaticResource Success}" />

                    <!-- Cancel Button -->
                    <Button Text="Annuler"
                            Command="{Binding CancelCommand}"
                            IsEnabled="{Binding IsSaving, Converter={StaticResource InvertedBoolConverter}}"
                            HeightRequest="50"
                            CornerRadius="25"
                            FontAttributes="Bold"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                            TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />

                </VerticalStackLayout>

                <!-- Saving Indicator -->
                <ActivityIndicator IsVisible="{Binding IsSaving}"
                                  IsRunning="{Binding IsSaving}"
                                  Color="{StaticResource Primary}"
                                  HeightRequest="40" />

                <!-- Error Message -->
                <Frame IsVisible="{Binding ErrorMessage, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                       BorderColor="{StaticResource Error}"
                       BackgroundColor="Transparent"
                       Padding="15"
                       CornerRadius="10"
                       HasShadow="False">
                    <Label Text="{Binding ErrorMessage}"
                           TextColor="{StaticResource Error}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center" />
                </Frame>

            </VerticalStackLayout>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
